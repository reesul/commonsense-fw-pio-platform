# Commonsense Platform for PlatformIO

This includes the files necessary to setup CommonSense in PlatformIO, along with some directions on how to do so.


## Creating a Project

To create a platformIO (PIO), PIO must be installed already. We generally use VSCode for this, but Atom has an extension for PIO as well; the following directions are for VSCode.

In a window of VSCode, there should be a set of icons along the left side of the window. One of them should be the PIO mascot, a bug/alien head. Click on this, and open a new terminal from Quick Access -> Miscellaneous  -> New Terminal. To create the project, navigate to a directory where you want to hold all the project files. It is recommended for this to be empty, as the command to establish a project will not create a new directory. To create the project, enter the following command: ```platformio project init```. Note that 'platformio' can be replaced with 'pio' as well for convenience. This command will create a few directories and files.

To create a CommonSense project, you will need to add the following code to the ```platformio.ini``` file within a project generated by platformIO. 

```
[env:commonsense]
platform = https://bitbucket.org/ccsg-res/commonsense-pio-platform.git ; Try the .git link
board = commonsense
framework = commonsense
```

You may need to run ```pio platform update``` if the above doesn't install when you attempt to build the project later.

You should then add a file called, preferably called 'main.c' to the 'src' directory. The file name can vary, but the important thing is that there is a function called 'main' in one (and only one) of these src files. Add this barebones code to the main file: 



```
#include <commonsense.h>


int main(void) {

}
    
```

And now you can build/compile! This may be done with the checkmark icon along the bottom left, or with the appropriately named "Build" (or Verbose Build) option in the PIO menus you looked through earlier to open the terminal.

## Uploading and Debugging a project

### Upload

Uploading a project means flashing the compiled firmware (a BIN file) onto an embedded device. This is what the right-pointing arrow will do! Similar to compiling, this can also be done from the set of PIO menus.

### Debug

Debugging a project is slightly more complex, as it requires a hardware tool, such as a JLink or Atmel-ICE. JLink is recommended. To use that, add the following line to the ```platformio.ini``` file 


```
debug_tool = jlink ; atmel-ice if that's what you have!

```

If you have atmel-ice or some other debugger, then specify that here.

To debug your project at runtime, you will initiate it slightly differently. After compiling, navigate to the icon on the left side of the window that has the 'play' icon and a small bug. When you click this, the pane will have a line near the top saying 'RUN' and an icon to press. Ensure the drop-down menu is a reference to the project you intend to debug. When you press it, it will try to upload the current binary and put the program into a debuggable mode. If you set breakpoints (red dots on the left side of specific lines of code), then it will pause execution when it hits those points in the code. You can look through memory, variables, etc. at this point. 

You can pause the code at any time, and if it is a normal running state, then it will stop wherever it is, taking you to the file that contains that line in the code. If it shows you the disassembly, then PIO wasn't able to determine where in the code you were; this may indicate a runtime error. In the paused state, you can use buttons near the top to step forward line-by-line. Different variants of step forward will 'step-in' to functions, taking you a layer deeper in the code; you may also 'step-over' to skip over called functions.